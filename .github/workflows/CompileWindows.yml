name: CompileWindows

on:
  # pull_request:
  workflow_dispatch:
      inputs:
        depth:
          type: choice
          description: depth
          default: a.b.c
          options:
            - a
            - a.b
            - a.b.c
            - a.b.c.d
            - a.b.c.d.e

defaults:
  run:
    shell: bash

jobs:
  windows_build:
    runs-on: windows-2022
    steps:
    - name: Clone
      shell: bash
      run: |
        pwd && pwd -W
        set -x
        function fastclone() { git clone --quiet --recurse-submodules --filter=tree:0 https://github.com/$1.git --branch $2 $3 ; }
        fastclone FirestormViewer/phoenix-firestorm ${GITHUB_REF_NAME/_VR/} ${GITHUB_WORKSPACE}
        fastclone ${GITHUB_REPOSITORY} ${GITHUB_REF_NAME} fsvr
        fastclone FirestormViewer/fs-build-variables master
        ls -lrtha

    - name: parse viewer_version.txt
      run: fsvr/detect_vars.sh | tee build_vars.env >> $GITHUB_ENV

    - name: Path
      shell: bash
      run: |
        echo "${workspace}/humbletim-bin" | tee -a $GITHUB_PATH
        MSYS_NO_PATHCONV=1 cmd.exe /C "mklink /J $(basename $build_dir) fsvr\\$(basename $build_dir)"

    - name: Tools
      shell: bash
      run: |
        python -m pip install -r requirements.txt
        curl -L -o ninja-win.zip https://github.com/ninja-build/ninja/releases/download/v1.10.2/ninja-win.zip
        unzip -d humbletim-bin ninja-win.zip

    - name: Preflight
      shell: bash
      run: |
        set -x
        python --version
        autobuild --version
        cmake --version
        ninja --version

    - name: Setup tmate session
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: true
